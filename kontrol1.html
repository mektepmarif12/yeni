<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Paneli - Cafe Sipariş Sistemi</title>
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #D2691E;
            --accent-color: #F4A460;
            --light-color: #FFF8DC;
            --dark-color: #654321;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: bold;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-title {
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .orders-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .order {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .order-items {
            margin-bottom: 10px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .order-notes {
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: black;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .history-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        
        /* Yeni eklenen stil: Ödenen siparişlerde ürün listesi için */
        .order-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .order-items-list {
            flex: 1;
        }
        
        .order-summary {
            flex: 1;
            text-align: right;
            padding-left: 20px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-links {
                display: flex;
                gap: 15px;
            }
            
            .nav-links a {
                margin-left: 0;
            }
            
            .order-details {
                flex-direction: column;
            }
            
            .order-summary {
                text-align: left;
                padding-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Kontrol Paneli</div>
            <div class="nav-links">
                <a href="index1.html">Sipariş Sayfası</a>
                <a href="#" id="clear-history">Geçmişi Temizle</a>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">Bugünkü Siparişler</h3>
                <div class="stat">
                    <span>Toplam Sipariş:</span>
                    <span id="total-orders">0</span>
                </div>
                <div class="stat">
                    <span>Bekleyen Sipariş:</span>
                    <span id="pending-orders">0</span>
                </div>
                <div class="stat">
                    <span>Ödenen Sipariş:</span>
                    <span id="paid-orders">0</span>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">Bugünkü Gelir</h3>
                <div class="stat">
                    <span>Toplam Gelir:</span>
                    <span id="total-revenue">₺0.00</span>
                </div>
                <div class="stat">
                    <span>Bekleyen Tutar:</span>
                    <span id="pending-revenue">₺0.00</span>
                </div>
            </div>
        </div>
        
        <div class="orders-section">
            <h2 class="card-title">Aktif Siparişler</h2>
            <div id="active-orders">
                <!-- Aktif siparişler buraya eklenecek -->
            </div>
        </div>
        
        <div class="history-section">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="order-history">Sipariş Geçmişi</div>
                    <div class="tab" data-tab="paid-orders">Ödenen Siparişler</div>
                </div>
                
                <div class="tab-content active" id="order-history">
                    <div id="all-orders">
                        <!-- Tüm siparişler buraya eklenecek -->
                    </div>
                </div>
                
                <div class="tab-content" id="paid-orders">
                    <div id="paid-orders-list">
                        <!-- Ödenen siparişler buraya eklenecek -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="new-order-notification">
        Yeni sipariş geldi!
    </div>

    <script>
        // JSONBin.io API bilgileri
        const BIN_ID = '68e4620ad0ea881f4097e383';
        const API_KEY = '$2a$10$V1jYPveOQ.2oEb4QsKv7A.SXw2w8pPG.5gNlGJtbxBHEFUEbMZu/O';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        
        // Son sipariş ID'sini takip etmek için
        let lastOrderId = 0;
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            // Siparişleri yükle
            loadOrders();
            
            // Tab işlevselliği
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Tüm tabları ve içerikleri deaktif et
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Tıklanan tabı aktif et
                    this.classList.add('active');
                    
                    // İlgili içeriği aktif et
                    const tabId = this.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Geçmişi temizle butonu
            document.getElementById('clear-history').addEventListener('click', function() {
                if (confirm('Tüm sipariş geçmişini silmek istediğinizden emin misiniz?')) {
                    clearAllOrders();
                }
            });
            
            // Yeni sipariş bildirimini kontrol et
            checkForNewOrders();
            
            // Her 5 saniyede bir siparişleri kontrol et
            setInterval(checkForNewOrders, 5000);
        });
        
        // Siparişleri yükle
        async function loadOrders() {
            try {
                const orders = await getOrdersFromJSONBin();
                
                // İstatistikleri güncelle
                updateStatistics(orders);
                
                // Aktif siparişleri göster
                displayActiveOrders(orders);
                
                // Tüm siparişleri göster
                displayAllOrders(orders);
                
                // Ödenen siparişleri göster
                displayPaidOrders(orders);
                
                // Son sipariş ID'sini güncelle
                if (orders.length > 0) {
                    lastOrderId = Math.max(...orders.map(order => order.id));
                }
            } catch (error) {
                console.error('Siparişler yüklenirken hata oluştu:', error);
            }
        }
        
        // JSONBin.io'dan siparişleri al
        async function getOrdersFromJSONBin() {
            const response = await fetch(API_URL + '/latest', {
                method: 'GET',
                headers: {
                    'X-Master-Key': API_KEY,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            return data.record || [];
        }
        
        // JSONBin.io'a siparişleri kaydet
        async function saveOrdersToJSONBin(orders) {
            const response = await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'X-Master-Key': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orders)
            });
            
            if (!response.ok) {
                throw new Error('Veri güncellenemedi');
            }
            
            return response.json();
        }
        
        // İstatistikleri güncelle
        function updateStatistics(orders) {
            const today = new Date().toDateString();
            
            // Bugünkü siparişleri filtrele
            const todayOrders = orders.filter(order => {
                const orderDate = new Date(order.timestamp).toDateString();
                return orderDate === today;
            });
            
            // İstatistikleri hesapla
            const totalOrders = todayOrders.length;
            const pendingOrders = todayOrders.filter(order => order.status === 'pending').length;
            const paidOrders = todayOrders.filter(order => order.status === 'paid').length;
            
            const totalRevenue = todayOrders.reduce((sum, order) => sum + order.total, 0);
            const pendingRevenue = todayOrders
                .filter(order => order.status === 'pending')
                .reduce((sum, order) => sum + order.total, 0);
            
            // İstatistikleri göster
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('paid-orders').textContent = paidOrders;
            
            document.getElementById('total-revenue').textContent = `₺${totalRevenue.toFixed(2)}`;
            document.getElementById('pending-revenue').textContent = `₺${pendingRevenue.toFixed(2)}`;
        }
        
        // Aktif siparişleri göster
        function displayActiveOrders(orders) {
            const activeOrdersContainer = document.getElementById('active-orders');
            activeOrdersContainer.innerHTML = '';
            
            // Bekleyen siparişleri al
            const pendingOrders = orders.filter(order => order.status === 'pending');
            
            if (pendingOrders.length === 0) {
                activeOrdersContainer.innerHTML = '<p>Bekleyen sipariş bulunmamaktadır.</p>';
                return;
            }
            
            // Siparişleri göster
            pendingOrders.forEach(order => {
                const orderElement = createOrderElement(order, true);
                activeOrdersContainer.appendChild(orderElement);
            });
        }
        
        // Tüm siparişleri göster
        function displayAllOrders(orders) {
            const allOrdersContainer = document.getElementById('all-orders');
            allOrdersContainer.innerHTML = '';
            
            if (orders.length === 0) {
                allOrdersContainer.innerHTML = '<p>Henüz sipariş bulunmamaktadır.</p>';
                return;
            }
            
            // Siparişleri ters sırada göster (en yeni en üstte)
            orders.slice().reverse().forEach(order => {
                const orderElement = createOrderElement(order, false);
                allOrdersContainer.appendChild(orderElement);
            });
        }
        
        // Ödenen siparişleri göster
        function displayPaidOrders(orders) {
            const paidOrdersContainer = document.getElementById('paid-orders-list');
            paidOrdersContainer.innerHTML = '';
            
            // Ödenen siparişleri al
            const paidOrders = orders.filter(order => order.status === 'paid');
            
            if (paidOrders.length === 0) {
                paidOrdersContainer.innerHTML = '<p>Henüz ödenmiş sipariş bulunmamaktadır.</p>';
                return;
            }
            
            // Siparişleri ters sırada göster (en yeni en üstte)
            paidOrders.slice().reverse().forEach(order => {
                const orderElement = createOrderElement(order, false, true);
                paidOrdersContainer.appendChild(orderElement);
            });
        }
        
        // Sipariş elementi oluştur
        function createOrderElement(order, showActions, isPaid = false) {
            const orderElement = document.createElement('div');
            orderElement.className = 'order';
            orderElement.dataset.orderId = order.id;
            
            // Tarih formatı
            const orderDate = new Date(order.timestamp);
            const formattedDate = orderDate.toLocaleString('tr-TR');
            
            // Ürün listesi oluştur
            let itemsHtml = '';
            for (const [item, quantity] of Object.entries(order.items)) {
                const itemName = getItemDisplayName(item);
                itemsHtml += `<div class="order-item">${itemName} x ${quantity}</div>`;
            }
            
            // Ödenen siparişler için farklı bir görünüm
            if (isPaid) {
                orderElement.innerHTML = `
                    <div class="order-header">
                        <span>Sipariş #${order.id} - ${order.tableNumber}</span>
                        <span>${formattedDate}</span>
                    </div>
                    <div class="order-details">
                        <div class="order-items-list">
                            ${itemsHtml}
                        </div>
                        <div class="order-summary">
                            <div><strong>Toplam: ₺${order.total.toFixed(2)}</strong></div>
                            <div style="color: var(--success-color); margin-top: 5px;">ÖDENDİ</div>
                        </div>
                    </div>
                    ${order.notes ? `<div class="order-notes"><strong>Not:</strong> ${order.notes}</div>` : ''}
                `;
            } else {
                orderElement.innerHTML = `
                    <div class="order-header">
                        <span>Sipariş #${order.id} - ${order.tableNumber}</span>
                        <span>${formattedDate}</span>
                    </div>
                    <div class="order-items">
                        ${itemsHtml}
                    </div>
                    ${order.notes ? `<div class="order-notes"><strong>Not:</strong> ${order.notes}</div>` : ''}
                    <div class="order-actions">
                        ${showActions ? `
                            <button class="btn btn-success" onclick="markOrderAsPaid(${order.id})">Ödendi</button>
                            <button class="btn btn-danger" onclick="deleteOrder(${order.id})">Sil</button>
                        ` : `
                            <span style="color: ${order.status === 'paid' ? 'var(--success-color)' : 'var(--warning-color)'}; font-weight: bold;">
                                ${order.status === 'paid' ? 'ÖDENDİ' : 'BEKLİYOR'}
                            </span>
                        `}
                    </div>
                `;
            }
            
            return orderElement;
        }
        
        // Ürün adını görüntüleme adına dönüştür
        function getItemDisplayName(itemKey) {
            const itemNames = {
                'simit': 'Simit',
                'pogaca': 'Poğaça',
                'sandvic': 'Sandviç',
                'turk-kahvesi': 'Türk Kahvesi',
                'latte': 'Latte',
                'cay': 'Çay'
            };
            
            return itemNames[itemKey] || itemKey;
        }
        
        // Siparişi ödendi olarak işaretle
        async function markOrderAsPaid(orderId) {
            try {
                const orders = await getOrdersFromJSONBin();
                const orderIndex = orders.findIndex(order => order.id === orderId);
                
                if (orderIndex !== -1) {
                    orders[orderIndex].status = 'paid';
                    await saveOrdersToJSONBin(orders);
                    
                    // Siparişleri yeniden yükle
                    loadOrders();
                    
                    // Bildirim göster
                    showNotification('Sipariş ödendi olarak işaretlendi');
                }
            } catch (error) {
                console.error('Sipariş güncellenirken hata oluştu:', error);
                alert('Sipariş güncellenirken bir hata oluştu.');
            }
        }
        
        // Siparişi sil
        async function deleteOrder(orderId) {
            if (!confirm('Bu siparişi silmek istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                const orders = await getOrdersFromJSONBin();
                const filteredOrders = orders.filter(order => order.id !== orderId);
                
                await saveOrdersToJSONBin(filteredOrders);
                
                // Siparişleri yeniden yükle
                loadOrders();
                
                // Bildirim göster
                showNotification('Sipariş silindi');
            } catch (error) {
                console.error('Sipariş silinirken hata oluştu:', error);
                alert('Sipariş silinirken bir hata oluştu.');
            }
        }
        
        // Tüm siparişleri temizle
        async function clearAllOrders() {
            try {
                await saveOrdersToJSONBin([]);
                
                // Siparişleri yeniden yükle
                loadOrders();
                
                // Bildirim göster
                showNotification('Tüm sipariş geçmişi temizlendi');
            } catch (error) {
                console.error('Siparişler temizlenirken hata oluştu:', error);
                alert('Siparişler temizlenirken bir hata oluştu.');
            }
        }
        
        // Yeni siparişleri kontrol et
        async function checkForNewOrders() {
            try {
                const orders = await getOrdersFromJSONBin();
                
                if (orders.length > 0) {
                    const maxOrderId = Math.max(...orders.map(order => order.id));
                    
                    if (maxOrderId > lastOrderId) {
                        // Yeni sipariş var
                        lastOrderId = maxOrderId;
                        showNotification('Yeni sipariş geldi!');
                        
                        // Siparişleri yeniden yükle
                        loadOrders();
                    }
                }
            } catch (error) {
                console.error('Yeni sipariş kontrolü sırasında hata:', error);
            }
        }
        
        // Bildirim göster
        function showNotification(message) {
            const notification = document.getElementById('new-order-notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>